name: Staging Release (Test Homebrew)

on:
  workflow_dispatch:

jobs:
  create-rc:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Generate version from commit
        id: version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="staging-${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Create RC tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag "v${VERSION}"
          git push origin "v${VERSION}"

      - name: Create tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p "/tmp/claw-${VERSION}"
          cp -r bin lib templates install.sh LICENSE "/tmp/claw-${VERSION}/"
          cd /tmp
          tar -czf "claw-${VERSION}.tar.gz" "claw-${VERSION}"
          
      - name: Calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA256=$(shasum -a 256 "/tmp/claw-${VERSION}.tar.gz" | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Create pre-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          gh release create "v${VERSION}" \
            "/tmp/claw-${VERSION}.tar.gz" \
            --title "v${VERSION} - Release Candidate" \
            --notes "## Testing Release
            
This is a release candidate for testing before the official release.

**Test with Homebrew:**
\`\`\`bash
# Method 1: Direct from tarball
brew uninstall claw 2>/dev/null || true
brew install https://github.com/bis-code/claw/releases/download/v${VERSION}/claw-${VERSION}.tar.gz

# Method 2: From staging tap (after updating formula)
brew tap bis-code/tap-staging
brew install claw
\`\`\`

**SHA256:** \`${{ steps.sha.outputs.sha256 }}\`

**Test checklist:**
- [ ] Installation succeeds
- [ ] \`claw --version\` shows correct version
- [ ] \`claw --help\` displays properly
- [ ] Basic commands work
- [ ] Claude integration works

Once testing is complete and all checks pass, proceed with the official release." \
            --prerelease
          
          echo "âœ… RC v${VERSION} created!"
          echo "ðŸ“¦ SHA256: ${{ steps.sha.outputs.sha256 }}"
          echo ""
          echo "Next steps:"
          echo "1. Test installation: brew install https://github.com/bis-code/claw/releases/download/v${VERSION}/claw-${VERSION}.tar.gz"
          echo "2. If tests pass, delete RC tag and proceed with official release"
          echo "3. Delete RC: gh release delete v${VERSION} --yes && git push origin :v${VERSION}"
