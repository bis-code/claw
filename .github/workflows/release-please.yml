name: Release Please

on:
  workflow_dispatch:  # Manual trigger only - no automatic releases
    inputs:
      reason:
        description: 'Reason for release'
        required: false
        default: 'Manual release'
  # push:
  #   branches:
  #     - main

permissions:
  contents: write
  pull-requests: write

env:
  HOMEBREW_TAP_REPO: bis-code/homebrew-tap

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
    steps:
      - name: Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: simple
          target-branch: main
          skip-github-release: true  # Don't create release yet, do it after tests pass

      - name: Checkout repository
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.release.outputs.tag_name }}
          fetch-depth: 0

      - name: Tag major and minor versions
        if: ${{ steps.release.outputs.release_created }}
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          # Create/update major version tag (v1)
          git tag -d v${{ steps.release.outputs.major }} 2>/dev/null || true
          git tag v${{ steps.release.outputs.major }}
          git push origin v${{ steps.release.outputs.major }} --force

          # Create/update minor version tag (v1.2)
          git tag -d v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }} 2>/dev/null || true
          git tag v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}
          git push origin v${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }} --force

  # Build and test FIRST, then create release
  build-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      sha256: ${{ steps.tarball.outputs.sha256 }}
      release_created: ${{ steps.create_release.outputs.release_created }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Setup BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git tests/bats
          git clone --depth 1 https://github.com/bats-core/bats-support.git tests/test_helper/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git tests/test_helper/bats-assert

      - name: Run tests
        run: ./tests/bats/bin/bats tests/*.bats

      - name: Extract release notes
        id: release_notes
        run: |
          VERSION=${{ needs.release-please.outputs.version }}
          # Extract just this version's notes from CHANGELOG.md
          awk "/## \[${VERSION}\]/,/## \[/{if(/## \[${VERSION}\]/)f=1; else if(/## \[/)exit; if(f)print}" CHANGELOG.md > release-notes.md
          cat release-notes.md

      - name: Create release tarball
        id: tarball
        run: |
          VERSION=${{ needs.release-please.outputs.version }}
          TARBALL_NAME="claw-${VERSION}.tar.gz"

          mkdir -p release-build/claw-${VERSION}
          cp -r bin release-build/claw-${VERSION}/
          cp -r lib release-build/claw-${VERSION}/
          cp -r templates release-build/claw-${VERSION}/
          cp install.sh release-build/claw-${VERSION}/
          cp README.md release-build/claw-${VERSION}/
          cp Makefile release-build/claw-${VERSION}/

          cd release-build
          tar -czvf "../${TARBALL_NAME}" "claw-${VERSION}"
          cd ..

          SHA256=$(sha256sum "${TARBALL_NAME}" | cut -d' ' -f1)

          echo "tarball=${TARBALL_NAME}" >> $GITHUB_OUTPUT
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "Created ${TARBALL_NAME} with SHA256: ${SHA256}"

      # Create GitHub release only after tests pass
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          name: ${{ needs.release-please.outputs.tag_name }}
          body_path: release-notes.md
          files: claw-${{ needs.release-please.outputs.version }}.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update Homebrew tap
  update-homebrew:
    needs: [release-please, build-release]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    steps:
      - name: Update Homebrew Tap
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          script: |
            const version = '${{ needs.release-please.outputs.version }}';
            const sha256 = '${{ needs.build-release.outputs.sha256 }}';

            const formula = `class Claw < Formula
              desc "Claude Automated Workflow - CLI tool for Claude Code configurations"
              homepage "https://github.com/bis-code/claw"
              url "https://github.com/bis-code/claw/releases/download/v${version}/claw-${version}.tar.gz"
              sha256 "${sha256}"
              license "MIT"
              version "${version}"

              def install
                bin.install "bin/claw"
                (lib/"claw").install Dir["lib/*"]
                (lib/"claw").install "templates"

                inreplace bin/"claw",
                  'LIB_DIR="\${SCRIPT_DIR}/../lib"',
                  "LIB_DIR=\\"\#{lib}/claw\\""
              end

              def caveats
                <<~EOS
                  Claw is now installed as a Claude Code wrapper.

                  Usage:
                    claw              - Start Claude Code with enhanced features
                    claw --yolo       - Skip permission prompts (dangerous!)
                    claw repos add    - Track a repository
                    claw templates    - Manage GitHub issue templates
                    claw --help       - Show all options
                EOS
              end

              test do
                system "\#{bin}/claw", "--version"
                system "\#{bin}/claw", "--help"
              end
            end`;

            const [owner, repo] = '${{ env.HOMEBREW_TAP_REPO }}'.split('/');
            let fileSha = null;

            try {
              const { data } = await github.rest.repos.getContent({
                owner,
                repo,
                path: 'Formula/claw.rb'
              });
              fileSha = data.sha;
            } catch (e) {
              console.log('Formula does not exist yet');
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: 'Formula/claw.rb',
              message: `Update claw to v${version}`,
              content: Buffer.from(formula).toString('base64'),
              sha: fileSha,
              committer: {
                name: 'GitHub Actions',
                email: 'actions@github.com'
              }
            });

            console.log('Homebrew tap updated!');

  # Sync VERSION variables in source files
  sync-version:
    needs: [release-please, build-release]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update VERSION in source files
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          echo "Updating VERSION to $VERSION"

          # Update bin/claw
          sed -i "s/VERSION=\"[^\"]*\"/VERSION=\"$VERSION\"/" bin/claw

          # Update install.sh
          sed -i "s/VERSION=\"[^\"]*\"/VERSION=\"$VERSION\"/" install.sh

          # Verify changes
          echo "bin/claw VERSION:"
          grep "^VERSION=" bin/claw || grep 'VERSION="' bin/claw | head -1

          echo "install.sh VERSION:"
          grep "^VERSION=" install.sh || grep 'VERSION="' install.sh | head -1

      - name: Commit and push VERSION sync
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          # Check if there are changes to commit
          if git diff --quiet bin/claw install.sh; then
            echo "No VERSION changes needed"
          else
            git add bin/claw install.sh
            git commit -m "chore: sync VERSION to ${{ needs.release-please.outputs.version }} [skip ci]"
            git push origin main
            echo "VERSION synced to ${{ needs.release-please.outputs.version }}"
          fi
