#!/usr/bin/env bash
#
# claude-setup - Claude Code configuration manager
#
# A tool to install, upgrade, and manage Claude Code configurations
# across multiple repositories.
#
# Usage:
#   claude-setup init              # Initialize in current repo
#   claude-setup upgrade           # Upgrade to latest version
#   claude-setup check             # Preview what would change
#   claude-setup export            # Export config from source repo
#   claude-setup version           # Show version info
#

set -euo pipefail

VERSION="0.1.3"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Load library functions
source "${LIB_DIR}/manifest.sh"
source "${LIB_DIR}/files.sh"
source "${LIB_DIR}/templates.sh"

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat << EOF
claude-setup v${VERSION} - Claude Code configuration manager

USAGE:
    claude-setup <command> [options]

COMMANDS:
    init [--force]       Initialize Claude config in current repo
    adopt                Adopt existing config (create manifest without overwriting)
    upgrade [--force]    Upgrade existing config to latest version
    check                Preview what would change (dry run)
    status               Show current installation status
    export <source>      Export config from a source repo
    version              Show version information

OPTIONS:
    --force              Overwrite all files, including modified ones
    --minimal            Skip optional files (commands, skills, checklists)
    --target <dir>       Target directory (default: current)
    -h, --help           Show this help message

EXAMPLES:
    # Initialize in a new project
    cd my-project
    claude-setup init

    # Adopt existing config (for projects already set up)
    claude-setup adopt

    # Check for updates
    claude-setup check

    # Upgrade, preserving local modifications
    claude-setup upgrade

    # Force upgrade everything
    claude-setup upgrade --force

    # Export from your main config repo
    claude-setup export ~/projects/my-config-repo

UPGRADE BEHAVIOR:
    - Files you haven't modified: automatically updated
    - Files you've modified: skipped (use --force to overwrite)
    - New files in updates: automatically created

For more info: https://github.com/bis-code/claude-code-setup
EOF
}

# ============================================================================
# Commands
# ============================================================================

cmd_version() {
    echo "claude-setup v${VERSION}"

    # Show installed version in current repo if exists
    local installed=$(get_installed_version ".")
    if [[ "$installed" != "0.0.0" ]]; then
        echo "Installed in current repo: v${installed}"
    fi
}

cmd_status() {
    local target="${1:-.}"
    local manifest="${target}/.claude/manifest.json"

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║       Claude Setup Status                                  ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    if [[ ! -f "$manifest" ]]; then
        echo -e "Status: ${YELLOW}Not installed${NC}"
        echo ""
        echo "Run 'claude-setup init' to set up Claude configuration."
        return
    fi

    local installed=$(get_installed_version "$target")
    local generated=$(grep -o '"generated": *"[^"]*"' "$manifest" | cut -d'"' -f4)
    local file_count=$(grep -c '"path":' "$manifest" || echo "0")

    echo -e "Status:    ${GREEN}Installed${NC}"
    echo -e "Version:   ${CYAN}v${installed}${NC}"
    echo -e "Generated: ${generated}"
    echo -e "Files:     ${file_count} managed files"
    echo ""

    # Check for modifications
    local modified=0
    while IFS= read -r line; do
        local path=$(echo "$line" | grep -o '"path": *"[^"]*"' | cut -d'"' -f4)
        if [[ -n "$path" ]] && is_file_modified "$target" "$path"; then
            ((modified++))
        fi
    done < <(grep '"path":' "$manifest")

    if [[ $modified -gt 0 ]]; then
        echo -e "${YELLOW}Modified files: ${modified}${NC} (will be preserved on upgrade)"
    fi

    echo ""
    echo "Run 'claude-setup check' to see available updates."
}

cmd_init() {
    local force=false
    local minimal=false
    local target="."

    while [[ $# -gt 0 ]]; do
        case $1 in
            --force) force=true; shift ;;
            --minimal) minimal=true; shift ;;
            --target) target="$2"; shift 2 ;;
            *) echo -e "${RED}Unknown option: $1${NC}"; exit 1 ;;
        esac
    done

    local manifest="${target}/.claude/manifest.json"

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    if [[ -f "$manifest" ]]; then
        echo -e "${BLUE}║       Claude Setup - Upgrade                               ║${NC}"
    else
        echo -e "${BLUE}║       Claude Setup - Initialize                            ║${NC}"
    fi
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    install_config "$target" "$force" "$minimal" false
}

cmd_upgrade() {
    cmd_init "$@"
}

cmd_check() {
    local target="."

    while [[ $# -gt 0 ]]; do
        case $1 in
            --target) target="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║       Claude Setup - Check                                 ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}CHECK MODE - Showing what would change${NC}"
    echo ""

    install_config "$target" false false true
}

cmd_adopt() {
    local target="${1:-.}"

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║       Claude Setup - Adopt Existing Config                 ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    if [[ ! -d "${target}/.claude" ]]; then
        echo -e "${RED}Error: No .claude directory found${NC}"
        echo "This command is for projects that already have Claude configuration."
        echo "Use 'claude-setup init' for new projects."
        exit 1
    fi

    if [[ -f "${target}/.claude/manifest.json" ]]; then
        echo -e "${YELLOW}Manifest already exists.${NC}"
        echo "Use 'claude-setup upgrade' to update, or delete manifest to re-adopt."
        exit 1
    fi

    echo -e "${YELLOW}Scanning existing configuration...${NC}"
    echo ""

    local count=0
    local manifest="${target}/.claude/manifest.json"

    # Start manifest
    mkdir -p "${target}/.claude"
    cat > "$manifest" << EOF
{
  "version": "$VERSION",
  "generated": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
  "generator": "claude-setup",
  "files": [
EOF

    local first=true

    # Scan all .claude files
    for file in $(find "${target}/.claude" -type f ! -name "manifest.json" 2>/dev/null | sort); do
        local relpath="${file#${target}/}"
        local checksum=$(shasum -a 256 "$file" | cut -d' ' -f1)

        if $first; then
            first=false
        else
            echo "," >> "$manifest"
        fi
        printf '    {"path": "%s", "checksum": "%s"}' "$relpath" "$checksum" >> "$manifest"

        echo -e "  ${GREEN}✓${NC} $relpath"
        count=$((count + 1))
    done

    # Also check for CLAUDE.md
    if [[ -f "${target}/CLAUDE.md" ]]; then
        local checksum=$(shasum -a 256 "${target}/CLAUDE.md" | cut -d' ' -f1)
        if ! $first; then
            echo "," >> "$manifest"
        fi
        printf '    {"path": "CLAUDE.md", "checksum": "%s"}' "$checksum" >> "$manifest"
        echo -e "  ${GREEN}✓${NC} CLAUDE.md"
        count=$((count + 1))
    fi

    # Close manifest
    cat >> "$manifest" << 'EOF'

  ]
}
EOF

    echo ""

    if [[ $count -eq 0 ]]; then
        echo -e "${RED}No files found to adopt.${NC}"
        rm -f "$manifest"
        exit 1
    fi

    echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║       Adoption Complete!                                   ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "  ${GREEN}Adopted:${NC} ${count} files"
    echo -e "  ${CYAN}Version:${NC} v${VERSION}"
    echo ""
    echo "Your existing config is now tracked."
    echo "Run 'claude-setup check' to see available updates."
    echo ""
}

cmd_export() {
    local source="$1"

    if [[ -z "$source" ]]; then
        echo -e "${RED}Error: Source repository path required${NC}"
        echo "Usage: claude-setup export <source-repo-path>"
        exit 1
    fi

    if [[ ! -d "$source/.claude" ]]; then
        echo -e "${RED}Error: No .claude directory found in $source${NC}"
        exit 1
    fi

    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║       Claude Setup - Export                                ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "Source: ${CYAN}$source${NC}"
    echo ""

    export_config "$source"
}

# ============================================================================
# Main
# ============================================================================

main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        init)
            cmd_init "$@"
            ;;
        adopt)
            cmd_adopt "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        check)
            cmd_check "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        export)
            cmd_export "$@"
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}"
            echo "Run 'claude-setup --help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
