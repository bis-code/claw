#!/usr/bin/env bash
#
# claw - Claude Automated Workflow
#
# Drop-in replacement for `claude` with better defaults.
# Usage is identical to claude - just type `claw` instead.
#

set -euo pipefail

# x-release-please-start-version
VERSION="1.2.0"
# x-release-please-end

# ============================================================================
# Configuration
# ============================================================================

CLAW_HOME="${CLAW_HOME:-$HOME/.claw}"
CLAUDE_HOME="${CLAUDE_HOME:-$HOME/.claude}"

# Source modules
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
source "${LIB_DIR}/repos.sh"
source "${LIB_DIR}/leann-mcp.sh"
source "${LIB_DIR}/issue-templates.sh"

# ============================================================================
# Colors
# ============================================================================

if [[ -t 1 ]]; then
    CYAN=$'\033[0;36m'
    GREEN=$'\033[0;32m'
    RED=$'\033[0;31m'
    GRAY=$'\033[0;90m'
    BOLD=$'\033[1m'
    NC=$'\033[0m'
else
    CYAN='' GREEN='' RED='' GRAY='' BOLD='' NC=''
fi

# ============================================================================
# One-time Setup (silent, automatic)
# ============================================================================

ensure_setup() {
    # Create claw home if needed
    if [[ ! -d "$CLAW_HOME" ]]; then
        mkdir -p "$CLAW_HOME"
        echo '{"version": "'"$VERSION"'"}' > "$CLAW_HOME/config.json"
    fi

    # Install claw's global commands into Claude's config
    # This makes /plan-day, /ship-day, etc. available everywhere
    if [[ -d "$CLAUDE_HOME" ]] && [[ ! -f "$CLAW_HOME/.commands-installed" ]]; then
        install_global_commands
    fi

    # Ensure leann MCP is set up (first-run only)
    # This provides semantic code search capabilities
    ensure_leann_setup || true  # Don't fail claw if leann setup fails
}

install_global_commands() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local templates_dir="${script_dir}/../templates/.claude/commands"

    # Create global commands directory
    mkdir -p "$CLAUDE_HOME/commands"

    # Copy claw commands to Claude's global commands
    if [[ -d "$templates_dir" ]]; then
        for cmd_file in "$templates_dir"/*.md; do
            if [[ -f "$cmd_file" ]]; then
                local name
                name=$(basename "$cmd_file")
                # Only copy if doesn't exist (don't overwrite user customizations)
                if [[ ! -f "$CLAUDE_HOME/commands/$name" ]]; then
                    cp "$cmd_file" "$CLAUDE_HOME/commands/$name"
                fi
            fi
        done
    fi

    # Mark as installed
    touch "$CLAW_HOME/.commands-installed"
}

# ============================================================================
# Session Management
# ============================================================================

get_last_session_id() {
    # Get the most recent session ID from Claude's history
    if [[ -f "$CLAUDE_HOME/history.jsonl" ]]; then
        # Extract session IDs and get the most recent one
        tail -100 "$CLAUDE_HOME/history.jsonl" 2>/dev/null | \
            grep -o '"sessionId":"[^"]*"' | \
            tail -1 | \
            sed 's/"sessionId":"//;s/"//'
    fi
}

show_exit_message() {
    local session_id="$1"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Session ended${NC}"

    if [[ -n "$session_id" ]]; then
        echo ""
        echo -e "  ${GREEN}To resume this session:${NC}"
        echo -e "  ${GRAY}claw --resume $session_id${NC}"
        echo ""
        echo -e "  ${GREEN}Or continue where you left off:${NC}"
        echo -e "  ${GRAY}claw --continue${NC}"
    fi

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# ============================================================================
# Startup Banner
# ============================================================================

show_startup_banner() {
    # Gather info
    local claude_version="not installed"
    local claude_status_icon="✗"
    local claude_status_color="$RED"
    if command -v claude &>/dev/null; then
        claude_version=$(claude --version 2>/dev/null | head -1 | sed 's/claude //' || echo "unknown")
        claude_status_icon="✓"
        claude_status_color="$GREEN"
    fi

    local current_repo
    current_repo=$(get_current_repo 2>/dev/null || echo "")

    local tracked_count=0
    if [[ -f "$CLAW_HOME/repos.json" ]]; then
        tracked_count=$(jq '.repos | length' "$CLAW_HOME/repos.json" 2>/dev/null || echo 0)
    fi

    # Box width: 78 chars total (76 inside + 2 for borders)
    local W=76

    # Helper to print a padded line (strips ANSI codes for length calculation)
    print_line() {
        local content="$1"
        # Strip ANSI escape codes for length calculation
        local stripped
        stripped=$(printf '%s' "$content" | sed $'s/\033\\[[0-9;]*m//g')
        local len=${#stripped}
        local pad=$((W - len))
        [[ $pad -lt 0 ]] && pad=0
        printf "${CYAN}│${NC}%s%*s${CYAN}│${NC}\n" "$content" "$pad" ""
    }

    echo ""
    printf "${CYAN}╭─ claw v${VERSION} "; printf '─%.0s' {1..62}; printf "╮${NC}\n"
    print_line ""
    print_line "    /\\___/\\             ${CYAN}${BOLD}Commands${NC}"
    print_line "   (  o o  )            /plan-day    Plan from GitHub issues"
    print_line "   (   >   )            /brainstorm  Multi-perspective analysis"
    print_line "    /|   |\\             /ship-day    Create PR when done"
    print_line "   (_|   |_)"
    print_line ""
    print_line " ${BOLD}Command Line${NC}           ${CYAN}${BOLD}Status${NC}"
    print_line " ${BOLD}Automated Workflow${NC}     Claude: ${claude_status_color}${claude_status_icon}${NC} ready"

    # Show current repo
    if [[ -n "$current_repo" ]]; then
        print_line "                        Current: ${GREEN}${current_repo}${NC}"
    else
        print_line "                        ${GRAY}Not in a git repo${NC}"
    fi

    # Show tracked repos
    if [[ $tracked_count -gt 0 ]]; then
        print_line "                        Tracked: ${CYAN}${tracked_count} repo(s)${NC}"
    else
        print_line "                        ${GRAY}No repos tracked${NC}"
    fi

    print_line ""
    printf "${CYAN}╰"; printf '─%.0s' {1..76}; printf "╯${NC}\n"
    echo ""
}

# ============================================================================
# Repos Command Handler
# ============================================================================

handle_repos_command() {
    local subcommand="${1:-}"
    shift 2>/dev/null || true

    case "$subcommand" in
        add)
            if [[ -z "${1:-}" ]]; then
                echo "Usage: claw repos add <owner/repo>"
                exit 1
            fi
            repos_add "$1"

            # Offer to configure issue templates (only in interactive mode)
            if [[ -t 0 ]]; then
                echo ""
                read -p "Configure GitHub issue templates for this repo? [y/N] " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    handle_templates_command install "$1"
                fi
            fi
            ;;
        remove|rm)
            if [[ -z "${1:-}" ]]; then
                echo "Usage: claw repos remove <owner/repo>"
                exit 1
            fi
            repos_remove "$1"
            ;;
        list|ls)
            repos_list
            ;;
        clear)
            if [[ -t 0 ]]; then
                read -p "Clear all tracked repos? [y/N] " -n 1 -r
                echo
                if [[ $REPLY =~ ^[Yy]$ ]]; then
                    repos_clear
                fi
            else
                # Non-interactive mode: require explicit --yes flag
                echo "Error: clear requires interactive confirmation or use 'claw repos clear --yes'"
                exit 1
            fi
            ;;
        ""|--help|-h)
            cat << 'EOF'
claw repos - Track multiple repositories

Usage:
  claw repos add <owner/repo>     Add a repo to track
  claw repos remove <owner/repo>  Remove a repo from tracking
  claw repos list                 List all tracked repos
  claw repos clear                Clear all tracked repos

When running /plan-day or /ship-day, claw aggregates across:
  1. Current directory's repo (from git remote)
  2. All tracked repos

Example:
  claw repos add myorg/backend
  claw repos add myorg/frontend
  claw repos list
  # Now /plan-day shows issues from both repos
EOF
            ;;
        *)
            echo "Unknown repos command: $subcommand"
            echo "Run 'claw repos --help' for usage"
            exit 1
            ;;
    esac
}

# ============================================================================
# Main
# ============================================================================

main() {
    # Track flags to pass to claude
    local SKIP_PERMISSIONS=false
    local CLAUDE_ARGS=()

    # Pre-process arguments to extract claw-specific flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yolo|-y)
                SKIP_PERMISSIONS=true
                shift
                ;;
            *)
                CLAUDE_ARGS+=("$1")
                shift
                ;;
        esac
    done

    # Restore positional parameters for backward compatibility
    set -- "${CLAUDE_ARGS[@]}"

    # Handle claw-specific commands
    case "${1:-}" in
        --version|-v|version)
            echo "claw v$VERSION (wraps claude)"
            claude --version 2>/dev/null || echo "claude not found"
            exit 0
            ;;
        --help|-h)
            cat << 'EOF'
claw - Command Line Automated Workflow

Usage: claw [arguments]

claw is a drop-in replacement for claude. All arguments are passed through.

Examples:
  claw                      # Start interactive chat
  claw "fix the bug"        # Start with a prompt
  claw --resume <id>        # Resume specific session
  claw --continue           # Continue last session
  claw --yolo "fix it"      # Skip all permission prompts

Options:
  --yolo, -y                Skip all permission prompts (DANGEROUS)
                            Passes --dangerously-skip-permissions to claude

GitHub issue templates:
  claw templates list           List available templates
  claw templates install <repo> Install templates to a repo
  claw templates --help         More info

Multi-repo tracking:
  claw repos add <owner/repo>   Add a repo to track
  claw repos list               List tracked repos
  claw repos remove <owner/repo> Remove a repo
  claw repos --help             More info

Claw adds:
  - Semantic code search via leann MCP (auto-installed on first run)
  - Global commands: /plan-day, /ship-day, /brainstorm, etc.
  - Multi-repo: aggregate issues across tracked repos
  - Session ID shown on exit for easy resume
  - Available in any project without setup

Setup:
  claw --setup-leann            Reinstall/reconfigure leann MCP
  claw --update                 Update global commands

Config: ~/.claw/
EOF
            exit 0
            ;;
        --update)
            # Force reinstall commands
            rm -f "$CLAW_HOME/.commands-installed"
            ensure_setup
            echo "Commands updated."
            exit 0
            ;;
        --setup-leann)
            # Force reinstall leann MCP
            reinstall_leann_mcp
            exit $?
            ;;
        repos)
            # Multi-repo management
            shift
            handle_repos_command "$@"
            exit $?
            ;;
        issues)
            # Fetch issues from all repos
            shift
            show_issues_summary "$@"
            exit $?
            ;;
        templates)
            # GitHub issue template management
            shift
            handle_templates_command "$@"
            exit $?
            ;;
    esac

    # Ensure claw is set up (silent, one-time)
    ensure_setup

    # Check if claude is available
    if ! command -v claude &>/dev/null; then
        echo "Error: claude not found. Install Claude Code first."
        echo "https://claude.ai/code"
        exit 1
    fi

    # Show startup banner (only for interactive sessions without args)
    if [[ $# -eq 0 ]] || [[ "${1:-}" == "--continue" ]] || [[ "${1:-}" == "-c" ]]; then
        show_startup_banner
    fi

    # Get session ID before running (to compare after)
    local session_before
    session_before=$(get_last_session_id)

    # Build claude command with flags
    local claude_cmd=("claude")
    if [[ "$SKIP_PERMISSIONS" == "true" ]]; then
        echo -e "${RED}${BOLD}⚠ YOLO MODE${NC}: Running with --dangerously-skip-permissions"
        echo ""
        claude_cmd+=("--dangerously-skip-permissions")
    fi

    # Run claude (not exec, so we can show exit message)
    local exit_code=0
    "${claude_cmd[@]}" "$@" || exit_code=$?

    # Get session ID after running
    local session_after
    session_after=$(get_last_session_id)

    # Show exit message with session ID (if it changed, meaning a session happened)
    if [[ "$session_after" != "$session_before" ]] && [[ -n "$session_after" ]]; then
        show_exit_message "$session_after"
    fi

    exit $exit_code
}

# Only run main if script is executed, not sourced (allows testing)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
