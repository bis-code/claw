#!/usr/bin/env bash
#
# claw - Claude Automated Workflow
#
# Drop-in replacement for `claude` with better defaults.
# Usage is identical to claude - just type `claw` instead.
#

set -euo pipefail

# x-release-please-start-version
VERSION="1.3.10"
# x-release-please-end

# ============================================================================
# Configuration
# ============================================================================

CLAW_HOME="${CLAW_HOME:-$HOME/.claw}"
CLAUDE_HOME="${CLAUDE_HOME:-$HOME/.claude}"

# Source modules
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
source "${LIB_DIR}/leann-mcp.sh"
source "${LIB_DIR}/issue-templates.sh"
source "${LIB_DIR}/projects.sh"

# ============================================================================
# Colors
# ============================================================================

if [[ -t 1 ]]; then
    CYAN=$'\033[0;36m'
    GREEN=$'\033[0;32m'
    RED=$'\033[0;31m'
    GRAY=$'\033[0;90m'
    BOLD=$'\033[1m'
    NC=$'\033[0m'
else
    CYAN='' GREEN='' RED='' GRAY='' BOLD='' NC=''
fi

# ============================================================================
# One-time Setup (silent, automatic)
# ============================================================================

ensure_setup() {
    # Create claw home if needed
    if [[ ! -d "$CLAW_HOME" ]]; then
        mkdir -p "$CLAW_HOME"
        echo '{"version": "'"$VERSION"'"}' > "$CLAW_HOME/config.json"
    fi

    # Install claw's global Claude configuration
    # This makes /plan-day, /ship-day, rules, skills, etc. available everywhere
    if [[ -d "$CLAUDE_HOME" ]] && [[ ! -f "$CLAW_HOME/.commands-installed" ]]; then
        install_global_claude_config
    fi

    # Ensure leann MCP is set up (first-run only)
    # This provides semantic code search capabilities
    ensure_leann_setup || true  # Don't fail claw if leann setup fails
}

install_global_claude_config() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local claude_templates_dir="${script_dir}/../templates/.claude"

    if [[ ! -d "$claude_templates_dir" ]]; then
        echo "Warning: Claude templates directory not found at $claude_templates_dir"
        return 1
    fi

    echo ""
    echo -e "${CYAN}✶${NC} ${BOLD}Installing Claude Code configuration${NC}"
    echo ""

    local installed=0

    # Commands
    if [[ -d "$claude_templates_dir/commands" ]]; then
        mkdir -p "$CLAUDE_HOME/commands"
        local count=0
        for file in "$claude_templates_dir/commands"/*.md; do
            [[ -f "$file" ]] || continue
            local name=$(basename "$file")
            if [[ ! -f "$CLAUDE_HOME/commands/$name" ]]; then
                cp "$file" "$CLAUDE_HOME/commands/$name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Commands (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Skills
    if [[ -d "$claude_templates_dir/skills" ]]; then
        mkdir -p "$CLAUDE_HOME/skills"
        local count=0
        for skill_dir in "$claude_templates_dir/skills"/*; do
            [[ -d "$skill_dir" ]] || continue
            local skill_name=$(basename "$skill_dir")
            if [[ ! -d "$CLAUDE_HOME/skills/$skill_name" ]]; then
                cp -r "$skill_dir" "$CLAUDE_HOME/skills/$skill_name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Skills (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Rules
    if [[ -d "$claude_templates_dir/rules" ]]; then
        mkdir -p "$CLAUDE_HOME/rules"
        local count=0
        for file in "$claude_templates_dir/rules"/*.md; do
            [[ -f "$file" ]] || continue
            local name=$(basename "$file")
            if [[ ! -f "$CLAUDE_HOME/rules/$name" ]]; then
                cp "$file" "$CLAUDE_HOME/rules/$name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Rules (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Agents
    if [[ -d "$claude_templates_dir/agents" ]]; then
        mkdir -p "$CLAUDE_HOME/agents"
        local count=0
        for file in "$claude_templates_dir/agents"/*.md; do
            [[ -f "$file" ]] || continue
            local name=$(basename "$file")
            if [[ ! -f "$CLAUDE_HOME/agents/$name" ]]; then
                cp "$file" "$CLAUDE_HOME/agents/$name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Agents (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Hooks
    if [[ -d "$claude_templates_dir/hooks" ]]; then
        mkdir -p "$CLAUDE_HOME/hooks"
        local count=0
        for file in "$claude_templates_dir/hooks"/*.sh; do
            [[ -f "$file" ]] || continue
            local name=$(basename "$file")
            if [[ ! -f "$CLAUDE_HOME/hooks/$name" ]]; then
                cp "$file" "$CLAUDE_HOME/hooks/$name"
                chmod +x "$CLAUDE_HOME/hooks/$name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Hooks (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Checklists
    if [[ -d "$claude_templates_dir/checklists" ]]; then
        mkdir -p "$CLAUDE_HOME/checklists"
        local count=0
        for file in "$claude_templates_dir/checklists"/*.md; do
            [[ -f "$file" ]] || continue
            local name=$(basename "$file")
            if [[ ! -f "$CLAUDE_HOME/checklists/$name" ]]; then
                cp "$file" "$CLAUDE_HOME/checklists/$name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Checklists (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Presets
    if [[ -d "$claude_templates_dir/presets" ]]; then
        mkdir -p "$CLAUDE_HOME/presets"
        local count=0
        for preset_dir in "$claude_templates_dir/presets"/*; do
            [[ -d "$preset_dir" ]] || continue
            local preset_name=$(basename "$preset_dir")
            if [[ ! -d "$CLAUDE_HOME/presets/$preset_name" ]]; then
                cp -r "$preset_dir" "$CLAUDE_HOME/presets/$preset_name"
                count=$((count + 1))
            fi
        done
        if [[ $count -gt 0 ]]; then
            echo -e "  ${GREEN}✓${NC} Presets (${count} installed)"
            installed=$((installed + 1))
        fi
    fi

    # Settings (only if doesn't exist)
    if [[ -f "$claude_templates_dir/settings.json" ]] && [[ ! -f "$CLAUDE_HOME/settings.json" ]]; then
        cp "$claude_templates_dir/settings.json" "$CLAUDE_HOME/settings.json"
        echo -e "  ${GREEN}✓${NC} Settings"
        installed=$((installed + 1))
    fi

    echo ""
    if [[ $installed -gt 0 ]]; then
        echo -e "${GREEN}✓${NC} ${BOLD}Claude configuration ready!${NC}"
    else
        echo -e "${GRAY}→${NC} Claude configuration already installed"
    fi
    echo ""

    # Mark as installed
    touch "$CLAW_HOME/.commands-installed"
}

# ============================================================================
# Session Management
# ============================================================================

get_last_session_id() {
    # Get the most recent session ID from Claude's history
    if [[ -f "$CLAUDE_HOME/history.jsonl" ]]; then
        # Extract session IDs and get the most recent one
        tail -100 "$CLAUDE_HOME/history.jsonl" 2>/dev/null | \
            grep -o '"sessionId":"[^"]*"' | \
            tail -1 | \
            sed 's/"sessionId":"//;s/"//'
    fi
}

show_exit_message() {
    local session_id="$1"

    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BOLD}Session ended${NC}"

    if [[ -n "$session_id" ]]; then
        echo ""
        echo -e "  ${GREEN}To resume this session:${NC}"
        echo -e "  ${GRAY}claw --resume $session_id${NC}"
        echo ""
        echo -e "  ${GREEN}Or continue where you left off:${NC}"
        echo -e "  ${GRAY}claw --continue${NC}"
    fi

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# ============================================================================
# Startup Banner
# ============================================================================

show_startup_banner() {
    # Gather info
    local claude_version="not installed"
    local claude_status_icon="✗"
    local claude_status_color="$RED"
    if command -v claude &>/dev/null; then
        claude_version=$(claude --version 2>/dev/null | head -1 | sed 's/claude //' || echo "unknown")
        claude_status_icon="✓"
        claude_status_color="$GREEN"
    fi

    local current_repo
    current_repo=$(get_current_repo 2>/dev/null || echo "")

    # Check for project context
    local current_project
    current_project=$(get_current_project 2>/dev/null || echo "")

    local project_repo_count=0
    if [[ -n "$current_project" ]]; then
        local config_file
        config_file=$(get_project_config "$current_project" 2>/dev/null)
        if [[ -f "$config_file" ]]; then
            project_repo_count=$(jq '.repos | length' "$config_file" 2>/dev/null || echo 0)
        fi
    fi

    # Box width: 78 chars total (76 inside + 2 for borders)
    local W=76

    # Helper to print a padded line (strips ANSI codes for length calculation)
    print_line() {
        local content="$1"
        # Strip ANSI escape codes for length calculation
        local stripped
        stripped=$(printf '%s' "$content" | sed $'s/\033\\[[0-9;]*m//g')
        local len=${#stripped}
        local pad=$((W - len))
        [[ $pad -lt 0 ]] && pad=0
        printf "${CYAN}│${NC}%s%*s${CYAN}│${NC}\n" "$content" "$pad" ""
    }

    echo ""
    printf "${CYAN}╭─ claw v${VERSION} "; printf '─%.0s' {1..62}; printf "╮${NC}\n"
    print_line ""
    print_line "    /\\___/\\             ${CYAN}${BOLD}Commands${NC}"
    print_line "   (  o o  )            /plan-day    Plan from GitHub issues"
    print_line "   (   >   )            /brainstorm  Multi-perspective analysis"
    print_line "    /|   |\\             /ship-day    Create PR when done"
    print_line "   (_|   |_)"
    print_line ""
    print_line " ${BOLD}Command Line${NC}           ${CYAN}${BOLD}Status${NC}"
    print_line " ${BOLD}Automated Workflow${NC}     Claude: ${claude_status_color}${claude_status_icon}${NC} ready"

    # Show project context (if in a project)
    if [[ -n "$current_project" ]]; then
        print_line "                        Project: ${GREEN}${current_project}${NC} (${project_repo_count} repos)"
    fi

    # Show current repo
    if [[ -n "$current_repo" ]]; then
        print_line "                        Repo: ${GREEN}${current_repo}${NC}"
    else
        print_line "                        ${GRAY}Not in a git repo${NC}"
    fi

    print_line ""
    printf "${CYAN}╰"; printf '─%.0s' {1..76}; printf "╯${NC}\n"
    echo ""
}

# ============================================================================
# Main
# ============================================================================

main() {
    # Track flags to pass to claude
    local SKIP_PERMISSIONS=false
    local CLAUDE_ARGS=()

    # Pre-process arguments to extract claw-specific flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --yolo|-y)
                SKIP_PERMISSIONS=true
                shift
                ;;
            *)
                CLAUDE_ARGS+=("$1")
                shift
                ;;
        esac
    done

    # Restore positional parameters for backward compatibility
    set -- "${CLAUDE_ARGS[@]}"

    # Handle claw-specific commands
    case "${1:-}" in
        --version|-v|version)
            echo "claw v$VERSION (wraps claude)"
            claude --version 2>/dev/null || echo "claude not found"
            exit 0
            ;;
        --help|-h)
            cat << 'EOF'
claw - Command Line Automated Workflow

Usage: claw [arguments]

claw is a drop-in replacement for claude. All arguments are passed through.

Examples:
  claw                      # Start interactive chat
  claw "fix the bug"        # Start with a prompt
  claw --resume <id>        # Resume specific session
  claw --continue           # Continue last session
  claw --yolo "fix it"      # Skip all permission prompts

Options:
  --yolo, -y                Skip all permission prompts (DANGEROUS)
                            Passes --dangerously-skip-permissions to claude

Project management (recommended):
  claw project create <name>    Create a new project
  claw project add-repo <path>  Add local folder to project
  claw project list             List all projects
  claw project show             Show current project details
  claw project issues           Fetch issues from all project repos
  claw project --help           More info

GitHub issue templates:
  claw templates list           List available templates
  claw templates install <repo> Install templates to a repo
  claw templates --help         More info

Claw adds:
  - Project-based multi-repo management (local folders)
  - Semantic code search via leann MCP (auto-installed on first run)
  - Global Claude configuration (commands, skills, rules, agents, hooks)
  - Aggregate issues across project repos
  - Session ID shown on exit for easy resume
  - Available in any project without setup

Setup:
  claw --setup-leann            Reinstall/reconfigure leann MCP
  claw --update                 Reinstall Claude configuration (skills, rules, etc.)

Config: ~/.claw/
EOF
            exit 0
            ;;
        --update)
            # Force reinstall Claude configuration
            rm -f "$CLAW_HOME/.commands-installed"
            ensure_setup
            echo "Claude configuration updated (commands, skills, rules, agents, etc.)."
            exit 0
            ;;
        --setup-leann)
            # Force reinstall leann MCP
            reinstall_leann_mcp
            exit $?
            ;;
        project)
            # Project-based multi-repo management
            shift
            handle_project_command "$@"
            exit $?
            ;;
        issues)
            # Fetch issues from all repos in current project
            shift
            local current_project
            current_project=$(get_current_project 2>/dev/null || echo "")
            if [[ -n "$current_project" ]]; then
                handle_project_command issues "$@"
            else
                echo "Not in a project. Create one with: claw project create <name>"
                echo "Or run from within a project directory."
            fi
            exit $?
            ;;
        templates)
            # GitHub issue template management
            shift
            handle_templates_command "$@"
            exit $?
            ;;
    esac

    # Ensure claw is set up (silent, one-time)
    ensure_setup

    # Check if claude is available
    if ! command -v claude &>/dev/null; then
        echo "Error: claude not found. Install Claude Code first."
        echo "https://claude.ai/code"
        exit 1
    fi

    # Show startup banner (only for interactive sessions without args)
    if [[ $# -eq 0 ]] || [[ "${1:-}" == "--continue" ]] || [[ "${1:-}" == "-c" ]]; then
        show_startup_banner
        # Auto-index project for semantic search if not already indexed
        ensure_project_indexed || true
    fi

    # Get session ID before running (to compare after)
    local session_before
    session_before=$(get_last_session_id)

    # Build claude command with flags
    local claude_cmd=("claude")
    if [[ "$SKIP_PERMISSIONS" == "true" ]]; then
        echo -e "${RED}${BOLD}⚠ YOLO MODE${NC}: Running with --dangerously-skip-permissions"
        echo ""
        claude_cmd+=("--dangerously-skip-permissions")
    fi

    # Run claude (not exec, so we can show exit message)
    local exit_code=0
    "${claude_cmd[@]}" "$@" || exit_code=$?

    # Get session ID after running
    local session_after
    session_after=$(get_last_session_id)

    # Show exit message with session ID (if it changed, meaning a session happened)
    if [[ "$session_after" != "$session_before" ]] && [[ -n "$session_after" ]]; then
        show_exit_message "$session_after"
    fi

    exit $exit_code
}

# Only run main if script is executed, not sourced (allows testing)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
