#!/usr/bin/env bash
#
# claw - Claude Automated Workflow
#
# A CLI tool to setup and manage Claude Code configurations
# with intelligent project detection and agent-based brainstorming.
#

set -euo pipefail

VERSION="0.4.3"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
TEMPLATES_DIR="${SCRIPT_DIR}/../templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Source libraries
source "$LIB_DIR/detect-project.sh"
source "$LIB_DIR/agents.sh"
source "$LIB_DIR/leann-setup.sh"
source "$LIB_DIR/manifest.sh"
source "$LIB_DIR/files.sh"
source "$LIB_DIR/templates.sh"

# ============================================================================
# Help
# ============================================================================

show_help() {
    echo -e "${BOLD}claw${NC} - Claude Automated Workflow"
    echo ""
    echo "Usage: claw <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init [--preset <name>]  Initialize Claude config in current directory"
    echo "  check                    Preview what would be updated (dry-run)"
    echo "  upgrade                  Upgrade existing configuration (smart merge)"
    echo "  detect                   Detect project type and show recommendations"
    echo "  agents <subcommand>      Manage agent roster"
    echo "  leann <subcommand>       LEANN semantic search integration"
    echo "  multi-repo <subcommand>  Multi-repo project support"
    echo "  version                  Show version information"
    echo "  help                     Show this help message"
    echo ""
    echo "Options:"
    echo "  --preset, -p <name>      Use specific preset (full, base, slim, etc.)"
    echo "  --force, -f              Force overwrite modified files"
    echo "  --minimal, -m            Skip optional files (commands, skills)"
    echo ""
    echo "Presets:"
    echo "  full     - All features enabled"
    echo "  base     - Standard configuration"
    echo "  slim     - Minimal configuration"
    echo "  hardhat  - Web3/Hardhat specific"
    echo "  unity    - Unity game development"
    echo "  react    - React/Next.js web app"
    echo ""
    echo "Examples:"
    echo "  claw init                 # Auto-detect and initialize"
    echo "  claw init --preset unity  # Initialize with Unity preset"
    echo "  claw check                # See what would be updated"
    echo "  claw upgrade              # Upgrade, preserving modified files"
    echo "  claw upgrade --force      # Upgrade, overwriting all files"
}

# ============================================================================
# Commands
# ============================================================================

cmd_version() {
    echo -e "${BOLD}claw${NC} v${VERSION}"
    echo "Claude Automated Workflow"
    echo ""
    echo "https://github.com/bis-code/claude-code-setup"
}

cmd_detect() {
    local target="${1:-.}"

    echo -e "${BOLD}Project Detection${NC}"
    echo ""

    print_detection_summary "$target"

    local multi_json
    multi_json=$(detect_multi_repo "$target")
    if echo "$multi_json" | grep -q '"detected": true'; then
        echo ""
        echo -e "${CYAN}Multi-Repo:${NC} Yes"
        echo "$multi_json" | grep '"name"' | sed 's/.*"name": "\([^"]*\)".*/  - \1/'
    fi
}

cmd_init() {
    local preset=""
    local target="."
    local force=false
    local minimal=false
    local dry_run=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --preset|-p)
                preset="$2"
                shift 2
                ;;
            --force|-f)
                force=true
                shift
                ;;
            --minimal|-m)
                minimal=true
                shift
                ;;
            --dry-run|--check)
                dry_run=true
                shift
                ;;
            *)
                target="$1"
                shift
                ;;
        esac
    done

    # Validate preset if specified
    if [[ -n "$preset" ]]; then
        case "$preset" in
            full|base|slim|hardhat|unity|react) ;;
            *)
                echo -e "${RED}Unknown preset: $preset${NC}"
                echo "Available presets: full, base, slim, hardhat, unity, react"
                exit 1
                ;;
        esac
    fi

    # Auto-detect preset if not specified
    if [[ -z "$preset" ]]; then
        local type
        type=$(detect_project_type "$target")
        case "$type" in
            game-unity) preset="unity" ;;
            web3) preset="hardhat" ;;
            saas|web) preset="react" ;;
            *) preset="base" ;;
        esac
        echo -e "${CYAN}Auto-detected preset:${NC} $preset (type: $type)"
    fi

    echo -e "${BOLD}claw${NC} v${VERSION} - Initializing..."
    echo ""

    # Use smart installation
    install_config "$target" "$force" "$minimal" "$dry_run" "$preset"
}

cmd_upgrade() {
    # Parse force flag
    local force=false
    local args=()
    for arg in "$@"; do
        if [[ "$arg" == "--force" ]] || [[ "$arg" == "-f" ]]; then
            force=true
        else
            args+=("$arg")
        fi
    done

    # Get installed preset
    local target="${args[0]:-.}"
    local installed_preset
    installed_preset=$(get_installed_preset "$target")

    echo -e "${BOLD}claw${NC} v${VERSION} - Upgrading..."
    echo ""

    # Call init with the installed preset (unless force, then use their settings)
    if $force; then
        cmd_init --force "${args[@]}"
    else
        cmd_init --preset "$installed_preset" "${args[@]}"
    fi
}

cmd_check() {
    echo -e "${BOLD}claw${NC} v${VERSION} - Checking for updates..."
    echo ""
    cmd_init --dry-run "$@"
}

cmd_agents() {
    local subcmd="${1:-list}"
    shift || true

    case "$subcmd" in
        list)
            local type
            type=$(detect_project_type ".")
            echo -e "${BOLD}Available Agents${NC}"
            echo -e "${CYAN}Project type:${NC} $type"
            echo ""

            local recommended
            recommended=$(get_agents_for_type "$type")

            echo -e "${GREEN}Recommended for this project:${NC}"
            for agent in $recommended; do
                echo -n "  - $agent"
                case "$agent" in
                    senior-dev) echo "  (Code architecture)" ;;
                    product) echo "  (User value, prioritization)" ;;
                    cto) echo "  (Technical strategy)" ;;
                    qa) echo "  (Testing, quality)" ;;
                    ux) echo "  (User experience)" ;;
                    security) echo "  (Security, compliance)" ;;
                    gameplay-programmer) echo "  (Game mechanics, player feel)" ;;
                    systems-programmer) echo "  (Core systems, performance)" ;;
                    tools-programmer) echo "  (Editor tools, automation, pipeline)" ;;
                    technical-artist) echo "  (Shaders, materials, VFX, optimization)" ;;
                    *) echo "  (no description)" ;;
                esac
            done
            echo ""
            echo "To see full agent prompt: claw agents spawn <name>"
            ;;
        spawn)
            local agent_name="${1:-}"
            if [[ -z "$agent_name" ]]; then
                echo -e "${RED}Usage: claw agents spawn <agent-name>${NC}"
                exit 1
            fi
            echo -e "${BOLD}Agent Prompt for:${NC} ${CYAN}$agent_name${NC}"
            echo ""
            echo "---"
            get_agent_prompt "$agent_name"
            echo "---"
            ;;
        *)
            echo -e "${RED}Unknown agents command: $subcmd${NC}"
            echo "Available: list, spawn"
            exit 1
            ;;
    esac
}

cmd_multi_repo() {
    local subcmd="${1:-detect}"
    shift || true

    case "$subcmd" in
        detect)
            echo -e "${BOLD}Multi-Repo Detection${NC}"
            echo ""
            local result
            result=$(detect_multi_repo ".")
            echo "$result" | while IFS= read -r line; do
                echo "$line"
            done
            ;;
        config)
            create_multi_repo_config "."
            ;;
        issues)
            echo -e "${BOLD}Fetching issues from all repositories...${NC}"
            echo ""
            fetch_multi_repo_issues "." "claude-ready"
            ;;
        *)
            echo -e "${RED}Unknown multi-repo command: $subcmd${NC}"
            echo "Available: detect, config, issues"
            exit 1
            ;;
    esac
}

# ============================================================================
# Main
# ============================================================================

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            cmd_version
            ;;
        init)
            cmd_init "$@"
            ;;
        detect)
            cmd_detect "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        check)
            cmd_check "$@"
            ;;
        agents)
            cmd_agents "$@"
            ;;
        leann)
            leann_cmd "$@"
            ;;
        multi-repo)
            cmd_multi_repo "$@"
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            echo "Run 'claw help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
