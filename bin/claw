#!/usr/bin/env bash
#
# claw - Claude Automated Workflow
#
# External orchestrator for Claude Code
# Wraps Claude Code with claw's prompts, rules, and autonomous capabilities
# while preserving ALL Claude Code features (bypass permission, shift+tab, MCP, etc.)
#

set -euo pipefail

# x-release-please-start-version
VERSION="0.6.0"
# x-release-please-end

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source libraries
source "$LIB_DIR/home.sh"
source "$LIB_DIR/output.sh" 2>/dev/null || true
source "$LIB_DIR/wrapper.sh"
source "$LIB_DIR/orchestrator.sh"

# Legacy libraries (for backwards compatibility)
[[ -f "$LIB_DIR/detect-project.sh" ]] && source "$LIB_DIR/detect-project.sh"
[[ -f "$LIB_DIR/agents.sh" ]] && source "$LIB_DIR/agents.sh"
[[ -f "$LIB_DIR/leann-setup.sh" ]] && source "$LIB_DIR/leann-setup.sh"

# ============================================================================
# Help
# ============================================================================

show_help() {
    cat << 'EOF'
claw - Claude Automated Workflow

External orchestrator for Claude Code. Wraps Claude Code with claw's prompts,
rules, and autonomous capabilities while preserving ALL Claude Code features.

USAGE:
    claw <command> [options]

MAIN COMMANDS:
    start [OPTIONS]         Start Claude Code with claw context (transparent wrapper)
    auto [OPTIONS]          Run autonomous development loop
    run "prompt"            Run Claude once with a prompt and exit
    skill <name>            Execute a claw skill

SETUP COMMANDS:
    init                    Initialize ~/.claw (first-time setup)
    config                  Show current claw configuration
    prompts                 List available prompts
    rules                   List available rules
    skills                  List available skills

LEGACY COMMANDS:
    detect                  Detect project type
    agents <cmd>            Manage agent roster
    leann <cmd>             LEANN semantic search

OPTIONS FOR 'start':
    --mode, -m <mode>       Use specific mode (base, tdd, autonomous)
    --rules, -r <rules>     Include specific rules (space-separated)
    --dir, -d <path>        Working directory (default: current)
    -- <args>               Pass remaining args to Claude Code

OPTIONS FOR 'auto':
    --hours, -h <N>         Time budget in hours (default: 4)
    --max-iterations, -n    Max loop iterations (default: 50)
    --task, -t "task"       Specific task to work on

EXAMPLES:
    claw init                           # First-time setup
    claw start                          # Start Claude with claw context
    claw start --mode tdd               # Start in TDD mode
    claw start --rules security         # Include security rules
    claw auto --hours 2                 # Autonomous mode for 2 hours
    claw run "fix the auth bug"         # One-shot command
    claw skill plan-day --hours 4       # Run a skill

HOW IT WORKS:
    Claw injects context into CLAUDE.md before starting Claude Code,
    then runs Claude Code directly. You get ALL Claude features:
    - Bypass permission toggle
    - Shift+Tab cycling
    - MCP servers
    - All keyboard shortcuts
    - Full terminal UI

CONFIGURATION:
    ~/.claw/
    ├── config.json         # Global settings
    ├── prompts/            # System prompts (base.md, tdd.md, etc.)
    ├── rules/              # Rule files (security.md, testing.md, etc.)
    ├── skills/             # Skill files (plan-day.md, etc.)
    └── logs/               # Session logs

VERSION:
    claw v${VERSION}
    https://github.com/bis-code/claw
EOF
}

# ============================================================================
# Commands
# ============================================================================

cmd_init() {
    local force=false
    [[ "${1:-}" == "--force" ]] && force=true

    echo "Setting up claw..."
    echo ""

    if $force; then
        setup_claw_home --force
    else
        setup_claw_home
    fi

    echo ""
    echo "Setup complete! Run 'claw start' to begin."
}

cmd_start() {
    run_claude "$@"
}

cmd_auto() {
    run_auto_loop "$@"
}

cmd_run() {
    run_claude_once "$@"
}

cmd_skill() {
    local skill_name="${1:-}"
    shift || true

    if [[ -z "$skill_name" ]]; then
        echo "Usage: claw skill <name> [args...]"
        echo ""
        list_skills
        return 1
    fi

    run_skill "$skill_name" "$@"
}

cmd_config() {
    show_claw_config
}

cmd_prompts() {
    list_prompts
}

cmd_rules() {
    list_rules
}

cmd_skills() {
    list_skills
}

cmd_version() {
    echo "claw v${VERSION}"
    echo "Claude Automated Workflow"
    echo ""
    echo "Home: ${CLAW_HOME:-~/.claw}"
    echo "https://github.com/bis-code/claw"
}

# Legacy commands for backwards compatibility
cmd_detect() {
    if type -t detect_project_type &>/dev/null; then
        local target="${1:-.}"
        echo "Project Detection"
        echo ""
        print_detection_summary "$target" 2>/dev/null || detect_project_type "$target"
    else
        echo "Detection not available in new architecture"
        echo "Use: claw start --mode <mode>"
    fi
}

cmd_agents() {
    if type -t get_agents_for_type &>/dev/null; then
        local subcmd="${1:-list}"
        shift || true

        case "$subcmd" in
            list)
                local type
                type=$(detect_project_type "." 2>/dev/null || echo "unknown")
                echo "Available Agents (project type: $type)"
                echo ""
                local recommended
                recommended=$(get_agents_for_type "$type" 2>/dev/null || echo "senior-dev qa")
                for agent in $recommended; do
                    echo "  - $agent"
                done
                ;;
            spawn)
                local agent_name="${1:-}"
                if [[ -z "$agent_name" ]]; then
                    echo "Usage: claw agents spawn <name>"
                    return 1
                fi
                get_agent_prompt "$agent_name"
                ;;
            *)
                echo "Unknown agents command: $subcmd"
                ;;
        esac
    else
        echo "Agents not available"
    fi
}

cmd_leann() {
    if type -t leann_cmd &>/dev/null; then
        leann_cmd "$@"
    else
        echo "LEANN integration not available"
    fi
}

cmd_status() {
    show_auto_status
}

cmd_stop() {
    stop_auto_loop
}

# ============================================================================
# Main
# ============================================================================

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        # Help
        help|--help|-h)
            show_help
            ;;

        # Main commands
        start)
            cmd_start "$@"
            ;;
        auto)
            cmd_auto "$@"
            ;;
        run)
            cmd_run "$@"
            ;;
        skill)
            cmd_skill "$@"
            ;;

        # Setup commands
        init)
            cmd_init "$@"
            ;;
        config)
            cmd_config
            ;;
        prompts)
            cmd_prompts
            ;;
        rules)
            cmd_rules
            ;;
        skills)
            cmd_skills
            ;;

        # Status commands
        status)
            cmd_status
            ;;
        stop)
            cmd_stop
            ;;

        # Version
        version|--version|-v)
            cmd_version
            ;;

        # Legacy commands
        detect)
            cmd_detect "$@"
            ;;
        agents)
            cmd_agents "$@"
            ;;
        leann)
            cmd_leann "$@"
            ;;
        multi-repo)
            echo "multi-repo deprecated. Use: claw start"
            ;;
        check|upgrade)
            echo "check/upgrade deprecated. Claw now uses ~/.claw for configuration."
            echo "Run: claw init"
            ;;

        *)
            echo "Unknown command: $cmd"
            echo "Run 'claw help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
